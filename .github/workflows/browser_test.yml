---
name: "Browser Functional Tests"

on:  # yamllint disable-line rule:truthy
  workflow_call:  # yamllint disable-line rule:empty-values

jobs:
  test:
    runs-on: "ubuntu-latest"
    timeout-minutes: 25
    steps:
      - uses: "actions/checkout@v4"
      - name: "Export Godot to Web"
        id: "export"
        # yamllint disable rule:line-length
        uses: "firebelley/godot-export@930577654862a320eef793f399ee911b4479efb9"  # Pinned to SHA for security (was @v6.0.0)
        with:
          godot_executable_download_url: "https://github.com/godotengine/godot/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip"
          godot_export_templates_download_url: "https://github.com/godotengine/godot/releases/download/4.5-stable/Godot_v4.5-stable_export_templates.tpz"
          relative_project_path: "./"  # Project root
          relative_export_path: "./export/web"  # Output folder
          archive_output: true  # Zips for upload (optional; disable if not needed)
          cache: true  # Enable caching for Godot executable and templates
      - name: "Set up Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.11"
      - name: "Cache PIP Dependencies"
        uses: "actions/cache@v4"
        with:
          path: "~/.cache/pip"
          key: "${{ runner.os }}-pip-gdtoolkit"
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: "Install Playwright"
        run: |
          pip install playwright pytest-playwright
          playwright install --with-deps chromium
      - name: "Start Server"
        # Background server
        run: |
          python -m http.server 8080 --directory export/web &
          sleep 5
      - name: "Run Tests"
        # Waits implicitly; add sleep if needed
        run: |
          pytest tests/browser_test.py
      - name: "Upload Screenshot Artifact"
        if: always()  # Even on failure
        uses: "actions/upload-artifact@v4"
        with:
          name: "test-screenshots"
          path: "main_menu.png"
