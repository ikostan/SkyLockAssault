---
name: "Trivy vulnerability scanner"

on:  # yamllint disable-line rule:truthy
  # Makes it reusable; called by other workflows
  workflow_call:  # yamllint disable rule:empty-values

jobs:
  security-scan:
    runs-on: "ubuntu-latest"
    permissions:  # Added: Explicit least-privilege permissions (adjust if needed)
      contents: read  # For checkout
      security-events: write  # For uploading SARIF to Security tab
    steps:
      - name: "Checkout code"
        uses: "actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332"  # Updated: Pinned to SHA for v4.1.7 tag (verify latest at https://github.com/actions/checkout/tags)

      - name: "Run Trivy vulnerability scanner"
        uses: "aquasecurity/trivy-action@0.28.0"  # Updated: Latest tag for reproducibility and newer Trivy version
        env:  # Added: Suppress version check notification (fallback)
          TRIVY_SKIP_VERSION_CHECK: 'true'
        with:
          version: 'latest'  # Added: Install the latest Trivy version to avoid outdated notices
          scan-type: 'fs'  # Scans the filesystem (your repo after checkout)
          scanners: 'vuln,secret,misconfig,license'  # Vulns, secrets, configs, licenses
          hide-progress: false
          format: 'sarif'  # Outputs in SARIF for GitHub integration (shows in Security tab)
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'  # Focus on serious issues
          exit-code: '1'  # Fail the workflow if critical/high vulns found (set to '0' to not fail)
          ignore-unfixed: true  # Ignore vulns without fixes available

      - name: "Upload Trivy scan results to GitHub Security tab"
        uses: "github/codeql-action/upload-sarif@83f0fe6c984a149f72f766b17cfedefea6849c18"  # Updated: Pinned to SHA for v3.0.0 tag (verify latest at https://github.com/github/codeql-action/tags)
        if: always()  # Upload even if scan fails
        with:
          sarif_file: 'trivy-results.sarif'
