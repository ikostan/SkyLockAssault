---
name: "Trivy vulnerability scanner"

on:  # yamllint disable-line rule:truthy
  # Makes it reusable; called by other workflows
  workflow_call:  # yamllint disable rule:empty-values

jobs:
  security-scan:
    runs-on: "ubuntu-latest"
    permissions:  # Explicit least-privilege permissions to satisfy Trivy's misconfig scanner
      contents: read  # For checkout
      security-events: write  # For uploading SARIF to Security tab
    steps:
      - name: "Checkout code"
        uses: "actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8"  # Pinned to SHA for v5.0.0 (latest as of 2025-10-28)

      - name: "Run Trivy vulnerability scanner"
        uses: "aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284"  # Pinned to SHA for v0.33.1 (latest as of 2025-10-28)
        env:  # Suppress version check notification
          TRIVY_SKIP_VERSION_CHECK: 'true'
        with:
          version: 'latest'
          scan-type: 'fs'  # Scans the filesystem (your repo after checkout)
          scanners: 'vuln,secret,misconfig,license'  # Vulns, secrets, configs, licenses
          hide-progress: false
          format: 'sarif'  # Outputs in SARIF for GitHub integration (shows in Security tab)
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'  # Focus on serious issues
          exit-code: '1'  # Fail the workflow if critical/high vulns found (set to '0' to not fail)
          ignore-unfixed: true  # Ignore vulns without fixes available

      - name: "Upload Trivy scan results to GitHub Security tab"
        uses: "github/codeql-action/upload-sarif@ef618feace3c4838ae42b239ab86e8fb46437508"  # Pinned to SHA for v4.32.2
        if: always()  # Upload even if scan fails
        with:
          sarif_file: 'trivy-results.sarif'
