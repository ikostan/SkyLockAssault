---
name: "Trivy vulnerability scanner"

on:  # yamllint disable-line rule:truthy
  # Makes it reusable; called by other workflows
  workflow_call:  # yamllint disable rule:empty-values

jobs:
  security-scan:
    runs-on: "ubuntu-latest"
    permissions:  # Explicit least-privilege permissions to satisfy Trivy's misconfig scanner
      contents: read  # For checkout
      security-events: write  # For uploading SARIF to Security tab
    steps:
      - name: "Checkout code"
        uses: "actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8"  # Pinned to SHA for v5.0.0 (latest as of 2025-10-28)

      - name: "Run Trivy vulnerability scanner"
        uses: "aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8"  # Pinned to SHA for v0.33.1 (latest as of 2025-10-28)
        env:  # Suppress version check notification
          TRIVY_SKIP_VERSION_CHECK: 'true'
        with:
          version: 'latest'
          scan-type: 'fs'  # Scans the filesystem (your repo after checkout)
          scanners: 'vuln,secret,misconfig,license'  # Vulns, secrets, configs, licenses
          hide-progress: false
          format: 'sarif'  # Outputs in SARIF for GitHub integration (shows in Security tab)
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'  # Focus on serious issues
          exit-code: '1'  # Fail the workflow if critical/high vulns found (set to '0' to not fail)
          ignore-unfixed: true  # Ignore vulns without fixes available

      - name: "Upload Trivy scan results to GitHub Security tab"
        uses: "github/codeql-action/upload-sarif@d198d2fabf39a7f36b5ce57ce70d4942944f006e"  # Pinned to SHA for v3.31.0 (latest stable as of 2025-10-28; fixes the invalid SHA error)
        if: always()  # Upload even if scan fails
        with:
          sarif_file: 'trivy-results.sarif'
