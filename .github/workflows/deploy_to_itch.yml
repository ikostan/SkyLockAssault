---
name: "Deploy to itch.io"

on:  # yamllint disable-line rule:truthy
  workflow_call:  # Reusable
    secrets:
      ITCHIO_API_KEY:
        description: "Itch.io API key"
        required: true

jobs:
  export-and-deploy:
    runs-on: "ubuntu-latest"
    # Adding 'timeout-minutes: 10' would prevent jobs from running
    # indefinitely if something goes wrong
    timeout-minutes: 10
    steps:
      - name: "Checkout code"
        uses: "actions/checkout@v6.0.1"
      - name: "Create Export Directories"
        run: |
          mkdir -p export/web
      - name: "Export Godot to Web"
        id: "export"
        # yamllint disable rule:line-length
        uses: "firebelley/godot-export@930577654862a320eef793f399ee911b4479efb9"  # Pinned to SHA for security (was @v6.0.0)
        with:
          godot_executable_download_url: "https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip"  # Updated to Godot 4.5-stable
          godot_export_templates_download_url: "https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_export_templates.tpz"  # Updated to Godot 4.5-stable
          relative_project_path: "./"  # Project root
          relative_export_path: "./export/web"  # Output folder
          archive_output: true  # Zips for upload
          verbose: true
          cache: true  # Enable caching for Godot executable and templates
          presets_to_export: "Web"
          use_preset_export_path: true  # Move exports to the directory defined in export_presets.cfg
      - name: "List Export Directory Contents"
        run: |
          echo "Files to be scanned in export:"
          ls -R export || echo "No files found—check if folder exists!"
          echo "Files to be scanned in export/web:"
          ls -R export/web || echo "No files found—check if folder exists!"
      - name: "Cache Butler"
        id: "cache-butler"
        uses: "actions/cache@v5"
        with:
          path: "butler"
          key: "${{ runner.os }}-butler-15.24.0-v2"  # Added -v2 to invalidate old cache
      - name: "Download Butler if not cached"
        if: "steps.cache-butler.outputs.cache-hit != 'true'"
        run: |
          curl -L --proto '=https' -o butler.zip https://broth.itch.zone/butler/linux-amd64/15.24.0/archive/default
          unzip butler.zip -d butler
          rm butler.zip
      - name: "Setup Butler"
        # Ensure file exists (safety for any edge cases)
        run: |
          if [ ! -f "butler/butler" ]; then
            echo "Error: butler executable not found. Cache may be invalid."
            exit 1
          fi
          chmod +x butler/butler
          echo "$(pwd)/butler" >> $GITHUB_PATH
      - name: "Deploy to itch.io with Butler"
        run: |
          butler --version
          butler push ${{ steps.export.outputs.archive_directory }}/Web.zip ikostan/sky-lock-assault:${{ github.ref_name }} --userversion ${{ github.ref_name }}
          butler status ikostan/sky-lock-assault:main
        # yamllint enable rule:line-length
        env:
          BUTLER_API_KEY: "${{ secrets.ITCHIO_API_KEY }}"
