---
name: "Deploy to itch.io"

on:
  workflow_call:  # Reusable
    secrets:
      ITCHIO_API_KEY:
        description: "Itch.io API key"
        required: true

jobs:
  export-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Export Godot to Web"
        id: export
        uses: firebelley/godot-export@v5.2.1  # Exports using your presets.cfg
        with:
          godot_executable_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4.1-stable/Godot_v4.4.1-stable_linux.x86_64.zip  # GitHub mirror
          godot_export_templates_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz  # GitHub mirror
          relative_project_path: ./  # Project root
          relative_export_path: ./export/web  # Output folder
          archive_output: true  # Zips for upload

      # - name: "Install Butler Manually"  # FIXED: Use zone domain, pinned v15.24.0, + --proto (matches screenshot URL)
      #  run: |
      #    # Download stable butler v15.24.0 binary ZIP for Linux AMD64 (~8.79 MiB)
      #    curl -L --proto '=https' -o butler.zip https://broth.itch.zone/butler/linux-amd64/15.24.0/archive/default  # Zone from screenshot, pinned to avoid LATEST errors
      #    unzip butler.zip  # Extracts 'butler' executable + libs
      #    chmod +x butler
      #    # Verify (should output "butler version 15.24.0")
      #    ./butler -V
      #    # Move to PATH
      #    sudo mv butler /usr/local/bin/

      - name: "Setup Butler"
        uses: remarkablegames/setup-butler@v2
        with:
          butler-version: LATEST
          cli-name: butler

      - name: "Deploy to itch.io with Butler"
        run: |
          butler --version
          butler push ${{ steps.export.outputs.archive_directory }}/Web.zip ikostan/sky-lock-assault:${{ github.ref_name }} --userversion ${{ github.ref_name }}
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
