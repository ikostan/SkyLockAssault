---
name: "Deploy to itch.io"

on:
  workflow_call:  # Reusable
    secrets:
      ITCHIO_API_KEY:
        description: "Itch.io API key"
        required: true

jobs:
  export-and-deploy:
    runs-on: ubuntu-latest
    container:  # NEW: Use godot-ci Docker for Godot 4.4 export (includes binary + templates)
      image: barichello/godot-ci:4.4-stable
    steps:
      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Setup Export Templates"  # NEW: Move templates to user dir (godot-ci requirement)
        run: |
          mkdir -p ~/.local/share/godot/export_templates
          mv /root/.local/share/godot/export_templates/4.4.stable ~/.local/share/godot/export_templates/4.4.stable

      - name: "Export Godot to Web"  # NEW: Direct godot command via container (uses your presets.cfg HTML5 preset)
        id: export
        run: |
          mkdir -p ./build/web
          godot --headless --export "HTML5" ./build/web/index.html  # Exports to folder; adjust preset name if not "HTML5"
          cd ./build/web && zip -r ../web.zip .  # Zip the web folder (matches your archive_output)
          echo "archive_directory=./build" >> $GITHUB_OUTPUT  # Output for push step

      # NEW: Butler publish action (installs Butler v15.24.0, pushes zipped web)
      - name: "Publish to itch.io"
        uses: manleydev/butler-publish-itchio-action@master
        with:
          api-key: ${{ secrets.ITCHIO_API_KEY }}  # Your secret
          itch-user: ikostan  # Your username
          itch-game: sky-lock-assault  # Game slug
          channel: ${{ github.ref_name }}  # Branch as channel (e.g., main)
          package: ${{ steps.export.outputs.archive_directory }}/web.zip  # Zipped web path
          version: ${{ github.ref_name }}  # Optional: Branch as version label
