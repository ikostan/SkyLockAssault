---
name: "CodeQL Scan on Web Export"

on:  # yamllint disable-line rule:truthy
  # Makes it reusable; called by other workflows
  workflow_call:  # yamllint disable rule:empty-values

jobs:
  export-and-scan:
    runs-on: "ubuntu-latest"
    # Adding 'timeout-minutes: 10' would prevent jobs from running
    # indefinitely if something goes wrong
    timeout-minutes: 10
    permissions:
      actions: "read"
      contents: "read"
      # Needed to upload SARIF results
      security-events: "write"
    strategy:
      fail-fast: false
      matrix:
        # Limit to JS for export/web files
        language: ["javascript"]

    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v6.0.1"

      - name: "Create Export Directories"
        run: |
          mkdir -p export/web

      - name: "Export Godot to Web"
        id: "export"
        # yamllint disable rule:line-length
        uses: "firebelley/godot-export@930577654862a320eef793f399ee911b4479efb9"  # Pinned to SHA for security (was @v6.0.0)
        with:
          godot_executable_download_url: "https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_linux.x86_64.zip"  # Updated to Godot 4.5-stable
          godot_export_templates_download_url: "https://github.com/godotengine/godot-builds/releases/download/4.5-stable/Godot_v4.5-stable_export_templates.tpz"  # Updated to Godot 4.5-stable
          relative_project_path: "./"  # Project root
          relative_export_path: "./export/web"  # Output folder
          archive_output: true  # Zips for upload
          verbose: true
          cache: true  # Enable caching for Godot executable and templates
          presets_to_export: "Web"
          use_preset_export_path: true  # Move exports to the directory defined in export_presets.cfg

      - name: "Flatten Export Directory"
        run: |
          # Explicitly fail if the directory doesn't exist
          if [ ! -d "export/web/Web" ]; then
            echo "Error: export/web/Web does not exist. Check the Godot export step."
            exit 1
          fi
          
          # Explicitly fail if the directory exists but is empty
          if [ -z "$(ls -A export/web/Web)" ]; then
            echo "Error: export/web/Web exists but is empty. Verify Godot export generated files."
            exit 1
          fi
          
          # Now flatten (mv and rmdir will succeed since we've confirmed non-empty)
          mv export/web/Web/* export/web/
          rmdir export/web/Web
      - name: "Patch index.js for security"
        run: |
          if [ ! -f "export/web/index.js" ]; then
            echo "Error: index.js not found in export/web"
            exit 1
          fi
          sed -i 's/Module\[handler\]=(\.\.\.args)=>{postMessage({cmd:"callHandler",handler,args})}/if (["print","printErr"].includes(handler)) { Module[handler]=(...args)=>{postMessage({cmd:"callHandler",handler,args})} }/g' export/web/index.js

      - name: "List files in export/web (for visibility)"
        run: |
          echo "Files to be scanned in export/web:"
          ls -R export/web || echo "No files found—check if folder exists!"

      - name: "Initialize CodeQL"
        uses: "github/codeql-action/init@v4.31.8"
        with:
          # yamllint disable rule:quoted-strings
          languages: ${{ matrix.language }}
          # References our path limiter
          config-file: ".github/codeql-config.yml"
          # Enables dep caching (minimal impact here but covers possibilities)
          dependency-caching: "true"
          # Enable debug for more detailed logs and artifacts
          debug: "false"

      - name: "Autobuild (optional for JS but included for completeness)"
        uses: "github/codeql-action/autobuild@v4.31.8"

      - name: "Perform CodeQL Analysis"
        uses: "github/codeql-action/analyze@v4.31.8"

      - name: "Post-scan summary (optional)"
        if: "always()"  # Run even if previous steps fail
        # yamllint disable rule:line-length
        run: |
          if [ -n "$(find . -name '*.sarif')" ]; then
            echo "Scan complete—check Security > Code scanning for results or download artifacts for debug info."
          else
            echo "Scan complete—no supported files or issues found. No results uploaded."
          fi
